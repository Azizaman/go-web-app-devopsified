name:   CI
on: 
  push:
    branches:
      - main
    paths-ignore:
      - 'helm/**'
      - 'k8/**'
      - 'README.md'

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: chceckout the code
              uses: actions/checkout@v4
            - name: set up go 
              uses: actions/setup-go@v5
              with:
                go-version: 1.22
            - name: build the project
              run: go build -o go-web-app
            - name: run tests
              run: go test ./...

    code-quality:
        runs-on: ubuntu-latest
        steps:
            - name: checkout the code
              uses: actions/checkout@v4

            - name: set up the go
              uses: actions/setup-go@v5
              with:
                go-version: 1.22
            - name: linting the code
              uses: golangci/golangci-lint-action@v9
              with:
                version: v2.6
    docker-image-push:
        runs-on: ubuntu-latest
        needs: [build,code-quality]

        steps:
            - name: checkout the code
              uses: actions/checkout@v4
            - name: set up docker buildx
              uses: docker/setup-buildx-action@v2
            - name: log in to teh docker hub
              uses: docker/login-action@v2
              with:
                username: ${{secrets.DOCKER_HUB_USERNAME}}
                password: ${{secrets.DOCKER_HUB_TOKEN}}
            
            - name: build and push with
              uses: docker/build-push-action@v4
              with:
                context: .
                file: ./Dockerfile
                push: true
                tags: |
                  ${{secrets.DOCKER_HUB_USERNAME}}/go-web-app:${{github.sha}}

    update-newtag-in-helm-chart:
        runs-on: ubuntu-latest
        needs: [docker-image-push]
        steps:
            - name: Checkout repository
              uses: actions/checkout@v5
              with:
                token: ${{ secrets.TOKEN }}
            - name: Update tag in Helm chart
              run: |
                sed -i 's/tag: .*/tag: "${{github.sha}}"/' helm/go-web-app-chart/values.yaml
            - name: Commit and push changes
              run: |
                git config --global user.email "abhishek@gmail.com"
                git config --global user.name "Abhishek Veeramalla"
                git add helm/go-web-app-chart/values.yaml
                git commit -m "Update tag in Helm chart"
                git push

    CD:
        runs-on: ubuntu-latest
        needs: [update-newtag-in-helm-chart]
        steps:
            - name: checkout the code
              uses: actions/checkout@v4
            - name: set up the kubectl aws eks
              uses: aws-actions/configure-aws-credentials@v4
              with:
                aws-access-key-id: ${{secrets.AWS_ACCESS_KEY_ID}}
                aws-secret-access-key: ${{secrets.AWS_SECRET_ACCESS_KEY}}
                aws-region: us-east-1
            - name: verify cluster access
              run: kubectl get nodes
            - name: update the kubecofig
              run: aws eks update-kubeconfig --region us-east-1 --name ${{secrets.EKS_CLUSTER_NAME}}
            - name: deploy the helm chart
              run: |
                helm upgrade --install go-web-app-release helm/go-web-app-chart --namespace go-web-app-namespace --create-namespace
                helm repo update
                

